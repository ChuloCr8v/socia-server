// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // binaryTargets = ["native", "rhel-openssl-1.0.x"]
  // output        = "../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  VENDOR
  RIDER
  USER
}

enum OrderStatus {
  PLACED
  CONFIRMED
  PREPARING
  READY
  PICKED_UP
  ON_THE_WAY
  DELIVERED
  CANCELLED
  PENDING
  RECEIVED
  REJECTED
}

enum OrderRejectionReason {
  OUT_OF_STOCK
  TEMP_UNAVAILABLE
  CLOSED
  NONE
  OTHERS
}

enum MenuAvailability {
  AVAILABLE
  UNAVAILABLE
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum AuthProvider {
  GOOGLE
  APPLE
  PASSWORD
}

enum BusinessType {
  PHARMACY
  RESTAURANT
  GROCERY
}

model BankInformation {
  id            String @id @default(uuid()) @db.Uuid
  bankName      String
  accountName   String
  accountNumber String
  vendor        Vendor @relation(fields: [vendorId], references: [id])
  vendorId      String @db.Uuid()

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Auth {
  passHash String?
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   String  @id @db.Uuid

  provider   AuthProvider?
  providerId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([provider, providerId])
}

enum OtpTypes {
  EMAIL_VERIFICATION
  RESET_PASSWORD
  ACCOUNT_VERIFICATION
}

enum NotificationType {
  ORDER
  PAYMENT
  SYSTEM
  PROMOTION
}

model Notification {
  id        String   @id @default(cuid())
  type      String // 'order' | 'status' | 'promo' | 'system'
  title     String
  message   String
  read      Boolean  @default(false)
  timestamp DateTime @default(now())

  senderId   String? @db.Uuid
  receiverId String? @db.Uuid

  sender   User? @relation("SentNotifications", fields: [senderId], references: [id])
  receiver User? @relation("ReceivedNotifications", fields: [receiverId], references: [id])
}

model Otp {
  id        String   @id @default(uuid()) @db.Uuid
  otp       String
  expiresAt DateTime
  type      OtpTypes
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @db.Uuid()

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id    String  @id @default(uuid()) @db.Uuid
  email String  @unique
  phone String? @unique
  name  String

  state   String?
  city    String?
  address String?

  userId String?  @unique
  auth   Auth?
  otps   Otp[]
  rating Rating[]

  profileImage Image?

  vendor     Vendor?
  isVerified Boolean @default(false)
  role       Role    @default(USER)

  status UserStatus? @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]

  //notifications
  sentNotifications     Notification[] @relation("SentNotifications")
  receivedNotifications Notification[] @relation("ReceivedNotifications")
  expoPushTokens        String[]
}

model Order {
  id               String                @id @default(uuid())
  orderId          String?               @unique
  userId           String                @db.Uuid
  vendorId         String                @db.Uuid
  status           OrderStatus
  subtotal         Float
  tax              Float
  deliveryFee      Float
  total            Float
  items            OrderItem[]
  deliveryAddress  String
  paymentReference String
  noteForRider     String?               @default("")
  rejectionReason  OrderRejectionReason?
  rejectionNote    String?

  user   User   @relation(fields: [userId], references: [id])
  vendor Vendor @relation(fields: [vendorId], references: [id])

  deliveredAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id        String            @id @default(uuid())
  orderId   String
  menuId    String
  name      String
  image     String?
  basePrice Float
  quantity  Int
  totalCost Float
  variant   OrderItemVariant?
  extras    OrderItemExtra[]
  note      String?           @default("")
  order     Order             @relation(fields: [orderId], references: [id])
}

model OrderItemVariant {
  id          String   @id @default(uuid())
  orderItemId String   @unique
  variantId   String
  name        String
  price       Float
  count       Int
  total       Float
  isDefault   Boolean? @default(false)

  orderItem OrderItem @relation(fields: [orderItemId], references: [id])
}

model OrderItemExtra {
  id          String @id @default(uuid())
  orderItemId String
  extraId     String
  name        String
  price       Float
  count       Int
  total       Float

  orderItem OrderItem @relation(fields: [orderItemId], references: [id])
}

model Image {
  id       String @id @default(uuid()) @db.Uuid
  publicId String @unique
  url      String

  menu   Menu?   @relation(fields: [menuId], references: [id], onDelete: Cascade)
  menuId String? @db.Uuid

  logoVendor   Vendor? @relation("VendorLogo", fields: [logoVendorId], references: [id])
  logoVendorId String? @unique @db.Uuid

  vendorProfileImage Vendor? @relation("VendorProfileImage", fields: [profileImageId], references: [id])
  profileImageId     String? @unique @db.Uuid

  headerVendor   Vendor? @relation("VendorHeaderImage", fields: [headerVendorId], references: [id])
  headerVendorId String? @unique @db.Uuid

  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String? @unique @db.Uuid

  category   Category? @relation(fields: [categoryId], references: [id])
  categoryId String?   @unique @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model OperatingHour {
  id      String    @id @default(uuid()) @db.Uuid
  day     String
  isOpen  Boolean   @default(true)
  opening DateTime?
  closing DateTime?

  vendor   Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId String @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Rating {
  id       String @id @default(uuid()) @db.Uuid
  vendor   Vendor @relation(fields: [vendorId], references: [id])
  vendorId String @db.Uuid

  user   User   @relation(fields: [userId], references: [id])
  userId String @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Vendor {
  id                  String            @id @default(uuid()) @db.Uuid
  vendorId            String            @unique
  logo                Image?            @relation("VendorLogo")
  profileImage        Image?            @relation("VendorProfileImage")
  headerImage         Image?            @relation("VendorHeaderImage")
  businessName        String
  email               String?           @unique
  businessDescription String?
  // businessLocation    String?
  businessCity        String?
  businessState       String?
  address             String?
  phone               String            @unique
  cac                 String?
  banks               BankInformation[]
  openingTime         DateTime?
  closingTime         DateTime?
  user                User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String            @unique @db.Uuid
  status              UserStatus?       @default(ACTIVE)
  businessCategory    String?
  rating              Rating[]
  deliveryTime        DateTime?
  deliveryFee         Int

  operatingHour OperatingHour[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  menu      Menu[]

  orders Order[]
}

model MenuItemSizeVariations {
  id           String            @id @unique @default(uuid()) @db.Uuid
  name         String
  price        String
  availability MenuAvailability? @default(AVAILABLE)
  qty          Int
  description  String?
  isDefault    Boolean           @default(false)
  menu         Menu              @relation(fields: [menuId], references: [id], onDelete: Cascade)
  menuId       String            @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model addOn {
  id           String            @id @unique @default(uuid()) @db.Uuid
  name         String
  price        String
  availability MenuAvailability? @default(AVAILABLE)
  qty          Int
  description  String?
  image        String?

  menu   Menu   @relation(fields: [menuId], references: [id], onDelete: Cascade)
  menuId String @db.Uuid

  isRequired Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Category {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @unique
  description String?
  image       Image?
  isActive    Boolean @default(true)

  menus  Menu[] // Relation to many menus
  menuId String? @db.Uuid

  businessType BusinessType? @default(RESTAURANT)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Menu {
  id String @id @unique @default(uuid()) @db.Uuid

  vendor   Vendor @relation(fields: [vendorId], references: [id])
  vendorId String @db.Uuid

  name            String
  description     String
  price           Decimal                  @db.Decimal(10, 2)
  availability    MenuAvailability?        @default(AVAILABLE)
  preparationTime Int
  stockQuantity   String?
  variants        MenuItemSizeVariations[]
  addons          addOn[]
  images          Image[]
  categories      Category[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}
